# Автоматизация сборки релиза OMV

В разработке следуем [GitFlow](https://bitworks.software/2019-03-12-gitflow-workflow.html).   
Релизы именуем согласно [cемантическому версионированию](https://semver.org/lang/ru/).   
Каждый сервис разрабатывается в своем репозитории.   
Общий сборщик находится в репозитории *omv-compose*.   

### Создание нового сервиса
На hub.docker.com нужно будет создать приватный репозиторий для сервиса в организации [OmegaLab](https://hub.docker.com/orgs/omegalab).   
Включить сервис в сборщик *omv-compose*.   

При инициации репозитория необходимо скопировать файлы CI/CD в папку `.github/workflows`:
- `pre-release--build-push.yml`
- `release--build-push.yml`

В настройках репозитория для вкладке *Secrets* необходимо добавить секреты с данными подключения к hub.docker.com:
- `DOCKER_USERNAME`
- `DOCKER_PASSWORD`

В качестве пароля необходимо создать для конкретного репозитория и использовать [ACCESS TOKEN](https://docs.docker.com/docker-hub/access-tokens/). 

### Разработка и создание пре-релиза

Для локального развертывания OMV используется файл `docker-compose.develop.yml` из репозитория *omv-compose*, в который разработчик вносит нужные ему корректировки.

Разработка ведется в ветках, наследуемых из ветки *develop* и сливаемых с нею при завершении. 

Для создания пре-релиза может создаваться отдельная ветка *release-X.X.X*   
Когда необходимо создать собраный образ для тестирования необходимо на подходящий коммит назначить тег вида *vX.X.X-rc.X*

```sh
$ git checkout release-1.3.7  #переход в ветку релиза
$ git tag -a v1.3.7-rc.1 -m "описание кандидат-релиза"  #создание тега
$ git push --tags  #отправка тегов
```

После синхронизации тегов с удаленным репозиторием, будет запущена сборка и отправка образа сервиса в регистр. Кроме тега с номером версии последнему образу будет назначен тег *develop*

### Развертывание пре-релизов в STAGING

Для развертывания на staging-сервере используется файл `docker-compose.staging.yml` из репозитория *omv-compose*, в который необходимо для тестируемых сервисов выставить номера пре-релизных версии или тег *develop*

### Создание релиза

После тестирования и принятия решения о выпуске релиза нужная ветка сливается с веткой *master* (так же если необходимо с веткой *develop*) и на этот коммит в *master'е* назначается тег *vX.X.X*   
*Таким образов в `master` находятся исключительно коммиты релизов*

```sh
$ git checkout master  # переход в мастер
$ git merge --no-ff release-1.3.7  # слияние релизной ветки с мастером. ключ --no-ff для сохранения истории коммитов
$ git tag -a v1.3.7 -m "описание релиза" #создание тега
$ git push --tags  #отправка тегов
```
После синхронизации тегов с удаленным репозиторием будет запущена сборка и отправка образа сервиса в регистр. Кроме тега с номером версии последнему образу будет назначен тег *latest*
```sh
$ git branch -d release-1.3.7 #ветку с релизом можно удалить
```

### Развертывание в PRODUCTION
Для развертывания на production используется файл `docker-compose.yml` из репозитория *omv-compose*, где для всех сервисов выставлены последние рабочие версии по тегу *latest*.

